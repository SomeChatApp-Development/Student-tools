let currentStep=1,foundIssues=[],originalText="",inputText=document.getElementById("input-text"),checkBtn=document.getElementById("check-btn"),errorsContainer=document.getElementById("errors-container"),GRAMMAR_RULES={grammar:[{pattern:"their|there|theyre",check:function(e,t){e=e.toLowerCase();return"their"===e&&t.match(/their\s+(is|are|was|were)/i)?{error:!0,suggestion:"there",message:"Use there for location or existence"}:"there"===e&&t.match(/there\s+(house|car|dog|cat|book|phone)/i)?{error:!0,suggestion:"their",message:"Use their for possession"}:{error:!1}}},{pattern:"your|youre",check:function(e,t){e=e.toLowerCase();return"your"===e&&t.match(/your\s+(going|coming|doing|being)/i)?{error:!0,suggestion:"youre",message:"Use youre before verbs"}:"youre"===e&&t.match(/youre\s+(house|car|dog|cat|book|phone)/i)?{error:!0,suggestion:"your",message:"Use your for possession"}:{error:!1}}}],verbTense:[{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(go|goes)\b/i,wrong:"go|goes",correct:"went",message:"Use past tense went after yesterday"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(buy|buys)\b/i,wrong:"buy|buys",correct:"bought",message:"Use past tense bought"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(eat|eats)\b/i,wrong:"eat|eats",correct:"ate",message:"Use past tense ate"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(see|sees)\b/i,wrong:"see|sees",correct:"saw",message:"Use past tense saw"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(come|comes)\b/i,wrong:"come|comes",correct:"came",message:"Use past tense came"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(take|takes)\b/i,wrong:"take|takes",correct:"took",message:"Use past tense took"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(make|makes)\b/i,wrong:"make|makes",correct:"made",message:"Use past tense made"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(do|does)\b/i,wrong:"do|does",correct:"did",message:"Use past tense did"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(have|has)\b/i,wrong:"have|has",correct:"had",message:"Use past tense had"},{pattern:/\b(yesterday|last\s+\w+|ago)\b.*\b(is|are)\b/i,wrong:"is|are",correct:"was|were",message:"Use past tense was or were"}],subjectVerb:[{pattern:/\b(I)\s+(is|was|has|does|goes|eats)\b/i,message:"Use am, had, do, go, eat with I"},{pattern:/\b(he|she|it)\s+(are|were|have|do|go|eat)\b/i,message:"Use is, was, has, does, goes, eats with he/she/it"},{pattern:/\b(they|we|you)\s+(is|was|has|does|goes|eats)\b/i,message:"Use are, were, have, do, go, eat with they/we/you"}],punctuation:[{pattern:"\\s+([.,!?;:])",message:"Remove space before punctuation",severity:"warning"},{pattern:"([.,!?;:])([A-Z])",message:"Add space after punctuation",severity:"warning"},{pattern:"\\s{2,}",message:"Multiple spaces detected",severity:"info"}],style:[{pattern:"very|really|quite|rather|somewhat|fairly",message:"Consider removing weak intensifiers",severity:"info",type:"Style"},{pattern:"basically|actually|literally|honestly",message:"Consider removing filler words",severity:"info",type:"Style"}]},commonMistakes={wnated:"wanted",directe:"directed",dby:"by",inpurt:"input",recieve:"receive",occured:"occurred",seperate:"separate",definately:"definitely",occassion:"occasion",accomodate:"accommodate",acheive:"achieve",beleive:"believe",calender:"calendar",teh:"the",adn:"and",taht:"that",waht:"what",becuase:"because",freind:"friend",thier:"their",recieved:"received",begining:"beginning",writting:"writing",occuring:"occurring",refering:"referring",transfered:"transferred",cemetary:"cemetery",concious:"conscious",existance:"existence",goverment:"government",harrass:"harass",independant:"independent",maintainance:"maintenance",neccessary:"necessary",occurance:"occurrence",priviledge:"privilege",reccomend:"recommend",refered:"referred",relevent:"relevant",succesful:"successful",tommorow:"tomorrow",untill:"until",wierd:"weird",whcih:"which",embarass:"embarrass",millenium:"millennium",miniscule:"minuscule",noticable:"noticeable",publically:"publicly",questionaire:"questionnaire",supercede:"supersede",tendancy:"tendency",truely:"truly",vaccuum:"vacuum"};function goHome(){window.location.href="index.html"}function toggleTheme(){document.body.classList.toggle("dark"),document.querySelector(".controls .btn-icon:last-child i").className=document.body.classList.contains("dark")?"fa-solid fa-sun":"fa-solid fa-moon",localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light")}function clearInput(){inputText.value="",updateCharCount(),resetStats(),showEmptyState()}function updateCharCount(){var e=inputText.value,t=e.length,e=e.trim().split(/\s+/).filter(function(e){return 0<e.length}).length;document.getElementById("input-count").textContent=t,document.getElementById("word-count").textContent=e}function resetStats(){document.getElementById("stat-errors").textContent="0",document.getElementById("stat-warnings").textContent="0",document.getElementById("stat-suggestions").textContent="0",document.getElementById("stat-readability").textContent="0",document.getElementById("stat-score").textContent="0%"}function showEmptyState(){errorsContainer.innerHTML='<div class="empty-state"><i class="fa-solid fa-clipboard-check"></i><p>No issues detected yet</p><p style="font-size: 0.85rem; margin-top: 0.5rem;">Click Check Grammar to analyze your text</p></div>'}function checkGrammar(){let e=inputText.value.trim();e?(originalText=e,foundIssues=[],setStep(2),checkBtn.disabled=!0,checkBtn.querySelector(".btn-text").textContent="Analyzing...",checkBtn.querySelector(".spinner").classList.remove("hidden"),setTimeout(function(){checkSpellingWithAPI(e)},800)):alert("Please enter some text first")}function checkSpellingWithAPI(a){var e=a.match(/\b[a-zA-Z]+\b/g)||[],t=Array.from(new Set(e.map(function(e){return e.toLowerCase()})));for(let e=0;e<t.length;e++){var s,n=t[e];n.length<2||commonMistakes[n]&&(s=new RegExp("\\b"+n+"\\b","gi"),s=a.match(s))&&foundIssues.push({type:"Spelling",severity:"error",text:s[0],originalWord:n,message:"Spelling error: "+s[0],suggestion:commonMistakes[n]})}fetch("https://api.sapling.ai/api/v1/edits",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:"HNGZPF6YJQXQVVVVVVVVVVVVVVVV",text:a,session_id:"test-session"})}).then(function(e){return e.json()}).then(function(t){if(t.edits&&0<t.edits.length)for(let e=0;e<t.edits.length;e++){var n=t.edits[e];let s=a.substring(n.start,n.end);var r=n.replacement||"";if(!foundIssues.some(function(e){return e.text.toLowerCase()===s.toLowerCase()})){let e="Grammar",t="error";"Spelling"===n.error_type?e="Spelling":"Grammar"===n.error_type?e="Grammar":"Punctuation"===n.error_type?(e="Punctuation",t="warning"):"Style"===n.error_type&&(e="Style",t="info"),foundIssues.push({type:e,severity:t,text:s,message:n.sentence||e+" error: "+s,suggestion:r})}}continueChecking(a)}).catch(function(e){console.log("Sapling API failed, using LanguageTool as backup"),fetch("https://api.languagetool.org/v2/check",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"text="+encodeURIComponent(a)+"&language=en-US"}).then(function(e){return e.json()}).then(function(s){if(s.matches)for(let e=0;e<s.matches.length;e++){var n=s.matches[e];let t=a.substring(n.offset,n.offset+n.length);var r=n.replacements&&0<n.replacements.length?n.replacements[0].value:"";foundIssues.some(function(e){return e.text.toLowerCase()===t.toLowerCase()})||foundIssues.push({type:"Grammar",severity:"error",text:t,message:n.message||"Grammar error",suggestion:r})}continueChecking(a)}).catch(function(){console.log("All APIs failed, using local rules only"),continueChecking(a)})})}function continueChecking(e){setTimeout(function(){checkVerbTense(e),setTimeout(function(){checkSubjectVerb(e),setTimeout(function(){checkGrammarRules(e),setTimeout(function(){checkPunctuation(e),setTimeout(function(){checkStyle(e),setStep(3),setTimeout(function(){displayResults(),updateStats(e),setStep(4),checkBtn.querySelector(".btn-text").textContent="Check Grammar",checkBtn.querySelector(".spinner").classList.add("hidden"),checkBtn.disabled=!1,setTimeout(function(){resetWorkflow()},3e3)},500)},500)},500)},500)},500)},500)}function checkVerbTense(t){for(let e=0;e<GRAMMAR_RULES.verbTense.length;e++){var s=GRAMMAR_RULES.verbTense[e];if(new RegExp(s.pattern.source,s.pattern.flags).test(t)){var n=new RegExp("\\b("+s.wrong+")\\b","gi"),r=t.match(n);if(r)for(let e=0;e<r.length;e++)foundIssues.push({type:"Grammar",severity:"error",text:r[e],suggestion:s.correct,message:s.message})}}}function checkSubjectVerb(t){for(let e=0;e<GRAMMAR_RULES.subjectVerb.length;e++){var s=GRAMMAR_RULES.subjectVerb[e],n=t.match(s.pattern);if(n)for(let e=0;e<n.length;e++)foundIssues.push({type:"Grammar",severity:"error",text:n[e],message:s.message})}}function checkGrammarRules(t){for(let e=0;e<GRAMMAR_RULES.grammar.length;e++){var s=GRAMMAR_RULES.grammar[e],n=new RegExp("\\b("+s.pattern+")\\b","gi"),r=t.split(/\b/);for(let e=0;e<r.length;e++){var a,o,i=r[e];n.test(i)&&(a=Math.max(0,e-3),o=Math.min(r.length,e+4),a=r.slice(a,o).join(""),(o=s.check(i,a)).error)&&foundIssues.push({type:"Grammar",severity:"error",text:i,suggestion:o.suggestion,message:o.message})}}}function checkPunctuation(t){for(let e=0;e<GRAMMAR_RULES.punctuation.length;e++)for(var s,n=GRAMMAR_RULES.punctuation[e],r=new RegExp(n.pattern,"g");null!==(s=r.exec(t));)foundIssues.push({type:"Punctuation",severity:n.severity,text:s[0],message:n.message,canAutoFix:!0})}function checkStyle(t){for(let e=0;e<GRAMMAR_RULES.style.length;e++)for(var s,n=GRAMMAR_RULES.style[e],r=new RegExp("\\b("+n.pattern+")\\b","gi");null!==(s=r.exec(t));)foundIssues.push({type:n.type||"Style",severity:n.severity,text:s[0],message:n.message})}function autoFixAll(){let t=inputText.value,s=0;var n=foundIssues.slice().sort(function(e,t){return t.text.length-e.text.length});for(let e=0;e<n.length;e++){var r,a=n[e];a.suggestion&&0<a.suggestion.length&&(r=new RegExp("\\b"+escapeRegex(a.text)+"\\b","gi"),(r=t.replace(r,a.suggestion))!==t)&&(t=r,s++)}t=(t=(t=t.replace(/\s+([.,!?;:])/g,"$1")).replace(/([.,!?;:])([A-Z])/g,"$1 $2")).replace(/\s{2,}/g," "),inputText.value=t,updateCharCount(),alert("Fixed "+s+" spelling/grammar issues and cleaned up punctuation!"),foundIssues=[],showEmptyState(),resetStats()}function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function displayResults(){if(0===foundIssues.length)errorsContainer.innerHTML='<div class="empty-state"><i class="fa-solid fa-circle-check" style="color: var(--success);"></i><p style="color: var(--success); font-weight: 600;">Perfect! No issues found</p><p style="font-size: 0.85rem; margin-top: 0.5rem;">Your text looks great!</p></div>';else{let t='<div style="margin-bottom: 1rem; text-align: center;"><button class="btn btn-primary" onclick="autoFixAll()" style="padding: 0.75rem 1.5rem;"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Fix All</button></div>';for(let e=0;e<foundIssues.length;e++){var s=foundIssues[e],n="error"===s.severity?"error":"warning"===s.severity?"warning":"info";t+='<div class="error-item '+n+'"><div class="error-header"><span class="error-type">'+s.type+'</span><span class="error-severity '+n+'">'+s.severity.toUpperCase()+'</span></div><div class="error-text">'+s.message+'</div><div class="error-text">Found: <span class="error-highlight">'+escapeHtml(s.text)+"</span></div>",s.suggestion&&(t+='<div class="error-suggestion">â†’ Suggestion: '+escapeHtml(s.suggestion)+"</div>"),t+="</div>"}errorsContainer.innerHTML=t}}function escapeHtml(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function updateStats(e){let t=0,s=0,n=0;for(let e=0;e<foundIssues.length;e++)"error"===foundIssues[e].severity?t++:"warning"===foundIssues[e].severity?s++:n++;document.getElementById("stat-errors").textContent=t,document.getElementById("stat-warnings").textContent=s,document.getElementById("stat-suggestions").textContent=n;var r=e.split(/\s+/).filter(function(e){return 0<e.length}).length,e=e.split(/[.!?]+/).filter(function(e){return 0<e.trim().length}).length;let a=0;0<r&&0<e&&(a=Math.round(100-r/e*2),a=Math.max(0,Math.min(100,a))),document.getElementById("stat-readability").textContent=a;r=Math.max(0,100-(10*t+5*s+2*n)),r=Math.round(r);document.getElementById("stat-score").textContent=r+"%"}function setStep(t,s){currentStep=t;var n=document.querySelectorAll(".step");for(let e=0;e<n.length;e++){var r=n[e];r.classList.remove("active","completed"),e+1<t||e+1===t&&s?r.classList.add("completed"):e+1===t&&r.classList.add("active")}}function resetWorkflow(){var t=document.querySelectorAll(".step");for(let e=0;e<t.length;e++)t[e].classList.remove("active","completed");document.getElementById("step-1").classList.add("active"),currentStep=1}inputText.addEventListener("input",function(){updateCharCount()}),window.addEventListener("load",function(){"dark"===localStorage.getItem("theme")&&(document.body.classList.add("dark"),document.querySelector(".controls .btn-icon:last-child i").className="fa-solid fa-sun")});